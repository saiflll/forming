<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MDCW Production Monitor</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />

    <!-- HTMX & Alpine (Local) -->
    <script src="/public/js/htmx.min.js"></script>
    <script src="/public/js/alpine.min.js" defer></script>

    <style>
      :root {
        --primary: #4f46e5;
        --primary-hover: #4338ca;
        --primary-light: #eef2ff;
        --bg-body: #f8fafc;
        --bg-card: #ffffff;
        --text-main: #0f172a;
        --text-muted: #64748b;
        --border: #e2e8f0;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1),
          0 1px 2px 0 rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -2px rgba(0, 0, 0, 0.05);
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: var(--text-main);
        line-height: 1.6;
        min-height: 100vh;
        padding-bottom: 2rem;
      }

      /* Navbar */
      .navbar {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid var(--border);
        padding: 1rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 100;
        box-shadow: var(--shadow);
      }

      .brand {
        font-size: 1.5rem;
        font-weight: 800;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .server-time {
        font-size: 0.875rem;
        color: var(--text-muted);
        background: var(--bg-body);
        padding: 0.5rem 1rem;
        border-radius: 9999px;
        border: 1px solid var(--border);
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 500;
      }

      .pulse {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      /* Container */
      .container {
        max-width: 1400px;
        margin: 2rem auto;
        padding: 0 1rem;
      }

      /* Cards */
      .card {
        background: var(--bg-card);
        border-radius: 16px;
        box-shadow: var(--shadow-lg);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border: 1px solid var(--border);
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--bg-body);
      }

      .card-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-main);
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      /* Tabs */
      .tabs {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin-bottom: 1.5rem;
        border-bottom: 2px solid var(--border);
        padding-bottom: 0.5rem;
      }

      .tab {
        padding: 0.75rem 1.5rem;
        font-size: 0.875rem;
        font-weight: 600;
        border-radius: 8px 8px 0 0;
        border: none;
        background: transparent;
        color: var(--text-muted);
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
      }

      .tab:hover {
        background: var(--primary-light);
        color: var(--primary);
      }

      .tab.active {
        background: var(--primary);
        color: white;
        box-shadow: var(--shadow);
      }

      /* Controls */
      .controls {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        align-items: center;
        background: var(--bg-body);
        padding: 1rem;
        border-radius: 10px;
        margin-bottom: 1.5rem;
      }

      .form-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex: 1;
        min-width: 150px;
      }

      label {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--text-muted);
        white-space: nowrap;
      }

      input,
      select {
        padding: 0.625rem 0.875rem;
        font-size: 0.875rem;
        border-radius: 8px;
        border: 1px solid var(--border);
        background-color: white;
        color: var(--text-main);
        outline: none;
        transition: all 0.15s;
        flex: 1;
      }

      input:focus,
      select:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px var(--primary-light);
      }

      input[type="search"] {
        padding-left: 2.5rem;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='11' cy='11' r='8'%3E%3C/circle%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'%3E%3C/line%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: 0.75rem center;
      }

      /* Buttons */
      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.625rem 1.25rem;
        font-size: 0.875rem;
        font-weight: 600;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
        gap: 0.5rem;
        white-space: nowrap;
      }

      .btn-primary {
        background: var(--primary);
        color: white;
      }

      .btn-primary:hover {
        background: var(--primary-hover);
        transform: translateY(-1px);
        box-shadow: var(--shadow);
      }

      .btn-success {
        background: var(--success);
        color: white;
      }

      .btn-success:hover {
        background: #059669;
        transform: translateY(-1px);
      }

      .btn-outline {
        background: white;
        border: 1px solid var(--border);
        color: var(--text-main);
      }

      .btn-outline:hover {
        background: var(--bg-body);
        border-color: var(--primary);
        color: var(--primary);
      }

      /* Table */
      .table-container {
        overflow-x: auto;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: white;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.875rem;
      }

      th {
        background: var(--bg-body);
        text-align: left;
        padding: 1rem 1.5rem;
        font-weight: 700;
        color: var(--text-main);
        border-bottom: 2px solid var(--border);
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.05em;
      }

      td {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--border);
        color: var(--text-main);
      }

      tr:last-child td {
        border-bottom: none;
      }

      tr:hover td {
        background: var(--primary-light);
      }

      /* Status Badges */
      .badge {
        display: inline-flex;
        align-items: center;
        padding: 0.375rem 0.875rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 700;
        letter-spacing: 0.025em;
      }

      .badge-success {
        background: #dcfce7;
        color: #166534;
      }

      .badge-danger {
        background: #fee2e2;
        color: #991b1b;
      }

      /* Stats */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
      }

      .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.25rem;
        border-radius: 12px;
        box-shadow: var(--shadow);
      }

      .stat-label {
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        opacity: 0.9;
      }

      .stat-value {
        font-size: 2rem;
        font-weight: 800;
        margin-top: 0.25rem;
      }

      /* Loading Indicator */
      .htmx-indicator {
        opacity: 0;
        transition: opacity 200ms ease-in;
      }
      .htmx-request .htmx-indicator {
        opacity: 1;
      }
      .htmx-request.htmx-indicator {
        opacity: 1;
      }

      .spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid rgba(0, 0, 0, 0.1);
        border-left-color: var(--primary);
        border-radius: 50%;
        animation: spin 0.6s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Responsive */
      @media (max-width: 768px) {
        .controls {
          flex-direction: column;
          align-items: stretch;
        }
        .form-group {
          min-width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar">
      <div class="brand">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="28"
          height="28"
          viewBox="0 0 24 24"
          fill="none"
          stroke="url(#grad1)"
          stroke-width="2.5"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <defs>
            <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style="stop-color: #667eea; stop-opacity: 1" />
              <stop
                offset="100%"
                style="stop-color: #764ba2; stop-opacity: 1"
              />
            </linearGradient>
          </defs>
          <path d="M3 3v18h18" />
          <path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3" />
        </svg>
        MDCW Production Monitor
      </div>
      <div class="server-time">
        <span
          class="pulse"
          style="
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            display: inline-block;
          "
        ></span>
        <span id="time-display">{{.Time}} WIB</span>
      </div>
    </nav>

    <div class="container" x-data="appData()">
      <!-- Summary Stats -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <rect x="3" y="3" width="7" height="7" />
              <rect x="14" y="3" width="7" height="7" />
              <rect x="14" y="14" width="7" height="7" />
              <rect x="3" y="14" width="7" height="7" />
            </svg>
            Produksi (1 Jam Terakhir)
          </h2>
          <button class="btn btn-outline" @click="refreshSummary()">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M23 4v6h-6" />
              <path d="M1 20v-6h6" />
              <path
                d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"
              />
            </svg>
            Refresh
          </button>
        </div>
        <div
          id="summary-container"
          hx-get="/summary"
          hx-trigger="load, every 60s"
          class="stats-grid"
        >
          <div style="color: var(--text-muted); font-size: 0.875rem">
            Loading summary...
          </div>
        </div>
      </div>

      <!-- Data Section with Tabs -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
              />
              <polyline points="14 2 14 8 20 8" />
              <line x1="12" y1="18" x2="12" y2="12" />
              <line x1="9" y1="15" x2="15" y2="15" />
            </svg>
            Data Log Produksi
          </h2>
          <div style="display: flex; gap: 0.5rem">
            <button class="btn btn-success" @click="exportToCSV()">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                <polyline points="7 10 12 15 17 10" />
                <line x1="12" y1="15" x2="12" y2="3" />
              </svg>
              Export CSV
            </button>
            <button class="btn btn-primary" @click="refreshData()">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M23 4v6h-6" />
                <path d="M1 20v-6h6" />
                <path
                  d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"
                />
              </svg>
              Refresh
            </button>
          </div>
        </div>

        <!-- Tabs per Prefix -->
        <div class="tabs">
          <button
            class="tab"
            :class="{ 'active': activeTab === 'all' }"
            @click="activeTab = 'all'; loadData()"
          >
            Semua Data
          </button>
          <template x-for="prefix in prefixes" :key="prefix">
            <button
              class="tab"
              :class="{ 'active': activeTab === prefix }"
              @click="activeTab = prefix; loadData()"
              x-text="prefix"
            ></button>
          </template>
        </div>

        <!-- Compact Single Row Filters -->
        <div class="controls" style="gap: 0.75rem; margin-bottom: 1.5rem;">
          <!-- Search -->
          <div class="form-group" style="flex: 2; min-width: 200px;">
            <input type="search" placeholder="üîç Cari ID, timestamp..." x-model="searchQuery" @input="filterData()">
          </div>

          <!-- Status Filter -->
          <div class="form-group" style="flex: 0 0 160px;">
            <select x-model="statusFilter" @change="loadData()" title="Filter Status">
              <option value="all">üìä Semua</option>
              <option value="41">‚úì OK (41)</option>
              <option value="521">‚úì OK (521)</option>
              <option value="553">‚úì OK (553)</option>
              <option value="8">‚è∏ Mesin Mati</option>
              <option value="9">üí§ Idle</option>
              <option value="90">üí§ Idle (90)</option>
              <option value="8201">üö´ Metal</option>
              <option value="25">‚ö† Under</option>
              <option value="73">‚úó Over</option>
            </select>
          </div>

          <!-- Sort -->
          <div class="form-group" style="flex: 0 0 160px;">
            <select x-model="sortBy" @change="loadData()" title="Sortir">
              <option value="newest">üïí Terbaru</option>
              <option value="weight_desc">‚¨á Berat Max</option>
              <option value="weight_asc">‚¨Ü Berat Min</option>
            </select>
          </div>

          <!-- Date Range -->
          <div class="form-group" style="flex: 0 0 140px;">
            <input type="date" x-model="startDate" @change="loadData()" title="Dari Tanggal" placeholder="üìÖ Dari">
          </div>

          <div class="form-group" style="flex: 0 0 140px;">
            <input type="date" x-model="endDate" @change="loadData()" title="Sampai Tanggal" placeholder="üìÖ Sampai">
          </div>

          <!-- Clear Date Filter -->
          <button 
            class="btn btn-outline" 
            @click="clearDateFilter()" 
            x-show="startDate || endDate"
            title="Clear Date Filter"
            style="flex: 0 0 auto; padding: 0.625rem 0.875rem;"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
          </button>
        </div>

        <!-- Table -->
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th width="8%">ID</th>
                <th width="18%">Timestamp</th>
                <th width="12%">Prefix</th>
                <th width="15%">Berat (g)</th>
                <th width="15%">Pack Count</th>
                <th width="15%">Status</th>
              </tr>
            </thead>
            <tbody id="data-tbody">
              <tr>
                <td
                  colspan="6"
                  style="
                    text-align: center;
                    padding: 3rem;
                    color: var(--text-muted);
                  "
                >
                  <div class="spinner" style="margin: 0 auto"></div>
                  <div style="margin-top: 1rem">Memuat data...</div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
        function appData() {
            return {
                activeTab: 'all',
                prefixes: [],
                searchQuery: '',
                statusFilter: 'all',
                sortBy: 'newest',
                startDate: '',
                endDate: '',
                allRecords: [],

                init() {
                    this.loadPrefixes();
                    this.loadData();
                },

                async loadPrefixes() {
                    try {
                        const response = await fetch('/prefixes');
                        this.prefixes = await response.json();
                    } catch (error) {
                        console.error('Error loading prefixes:', error);
                    }
                },

                loadData() {
                    // If date range is set, use date-based endpoint
                    if (this.startDate || this.endDate) {
                        this.loadDataByDate();
                        return;
                    }

                    // Otherwise use normal endpoint
                    const params = new URLSearchParams({
                        prefix: this.activeTab,
                        status: this.statusFilter,
                        sort: this.sortBy
                    });
                    
                    const url = this.activeTab === 'all' 
                        ? `/data-list?${params}` 
                        : `/data-by-prefix?${params}`;

                    htmx.ajax('GET', url, {
                        target: '#data-tbody',
                        swap: 'innerHTML'
                    });
                },

                loadDataByDate() {
                    const params = new URLSearchParams({
                        start_date: this.startDate || '',
                        end_date: this.endDate || '',
                        status: this.statusFilter,
                        sort: this.sortBy
                    });

                    htmx.ajax('GET', `/data-by-date?${params}`, {
                        target: '#data-tbody',
                        swap: 'innerHTML'
                    });
                },

                clearDateFilter() {
                    this.startDate = '';
                    this.endDate = '';
                    this.loadData();
                },

                filterData() {
                    // Client-side search filtering
                    this.loadData();
                },

                refreshData() {
                    this.loadData();
                },

                refreshSummary() {
                    htmx.ajax('GET', '/summary', {
                        target: '#summary-container',
                        swap: 'innerHTML'
                    });
                },

                async exportToCSV() {
                    const table = document.querySelector('table');
                    let csv = [];
                    
                    // Headers
                    const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
                    csv.push(headers.join(','));
                    
                    // Rows
                    const rows = table.querySelectorAll('tbody tr');
                    rows.forEach(row => {
                        const cells = Array.from(row.querySelectorAll('td')).map(td => {
                            return '"' + td.textContent.trim().replace(/"/g, '""') + '"';
                        });
                        if (cells.length > 1) { // Skip empty rows
                            csv.push(cells.join(','));
                        }
                    });
                    
                    // Download
                    const csvContent = csv.join('\n');
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `production_data_${new Date().toISOString().slice(0,10)}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            }
        }
    </script>
  </body>
</html>
```
